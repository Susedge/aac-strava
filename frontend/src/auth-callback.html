<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Auth callback</title>
    <style>
      body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#07101b,#0f1724);color:#e6eef6;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
      .card{max-width:560px;padding:28px;border-radius:12px;background:rgba(255,255,255,0.02);text-align:center;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
      .btn{display:inline-block;margin-top:14px;padding:8px 14px;border-radius:8px;background:linear-gradient(90deg,#ff5a3c,#ff7b5a);color:white;text-decoration:none}
    </style>
  </head>
  <body>
    <div class="card">
      <h2 id="title">Signing in...</h2>
      <p id="msg">Waiting for Strava...</p>
      <a id="go" class="btn" href="/" style="display:none">Go to leaderboard</a>
    </div>

    <script>
      (async function(){
        const params = new URLSearchParams(location.search);
        const code = params.get('code');
        const error = params.get('error');
        if (error) {
          document.getElementById('title').textContent = 'Authorization failed';
          document.getElementById('msg').textContent = error;
          return;
        }
        if (!code) {
          document.getElementById('title').textContent = 'No code found';
          document.getElementById('msg').textContent = 'No authorization code was returned.';
          return;
        }

        document.getElementById('msg').textContent = 'Exchanging code for tokens...';
        try {
          const res = await fetch((import.meta.env.VITE_API_BASE || 'http://localhost:4000') + '/auth/strava/callback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code })
          });
          const json = await res.json();
          if (!res.ok) {
            document.getElementById('title').textContent = 'Exchange failed';
            document.getElementById('msg').textContent = JSON.stringify(json);
            return;
          }
          document.getElementById('title').textContent = 'Authorized';
          document.getElementById('msg').textContent = 'Account connected. Redirecting...';
          document.getElementById('go').style.display = 'inline-block';
          setTimeout(()=> location.href='/', 1200);
        } catch (err) {
          document.getElementById('title').textContent = 'Network error';
          document.getElementById('msg').textContent = err.message || String(err);
        }
      })();
    </script>
  </body>
</html>
