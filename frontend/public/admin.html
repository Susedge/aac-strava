<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AAC Admin</title>
    <link rel="stylesheet" href="/src/styles.css">
  </head>
  <body>
    <div class="admin-page">
      <header style="display:flex;align-items:center;justify-content:space-between">
        <h2 style="margin:0">AAC Admin — Members</h2>
        <div>
          <button id="refreshBtn" class="btn">Refresh Aggregation</button>
          <button id="reloadBtn" class="btn" style="margin-left:8px">Reload List</button>
        </div>
      </header>
      <main style="margin-top:12px">
        <div id="processing" style="display:none;margin-bottom:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);">Processing… please wait</div>
        <div id="athletes" class="athletes-container"></div>
      </main>
    </div>

    <!-- Admin unlock overlay -->
    <div id="adminOverlay" class="admin-overlay" style="display:none">
      <div class="admin-lock">
        <h2>AAC Admin</h2>
        <div class="lock-form">
          <label>Enter password to continue</label>
          <input id="adminPassword" type="password" placeholder="Password">
          <div class="hint">This is a client-side gate for local admin use.</div>
          <div class="actions">
            <button id="unlockBtn" class="btn">Unlock</button>
            <a id="backLink" class="back-link" href="/">Back to site</a>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Admin overlay logic
      (function(){
        const overlay = document.getElementById('adminOverlay');
        const pwd = document.getElementById('adminPassword');
        const unlock = document.getElementById('unlockBtn');
        const BACK_KEY = 'admin_unlocked';
        function show() { overlay.style.display = 'flex'; setTimeout(()=>pwd.focus(),50); }
        function hide() { overlay.style.display = 'none'; }
        const unlocked = sessionStorage.getItem(BACK_KEY) === '1';
        if (!unlocked) show(); else hide();
        unlock.addEventListener('click', ()=>{
          const val = (pwd.value||'').trim();
          // client-side password check: 'susedge'
          if (val === 'susedge') {
            sessionStorage.setItem(BACK_KEY,'1'); hide();
          } else {
            pwd.value = ''; pwd.focus(); alert('Incorrect password');
          }
        });
        // allow Enter key to unlock
        pwd.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') unlock.click(); });
      })();

      const API = (window.__API_BASE__ || 'http://localhost:4000');
      async function load(){
        const container = document.getElementById('athletes'); container.innerHTML = '<div class="loading">Loading…</div>';
        try{
          const r = await fetch(API + '/admin/athletes'); const j = await r.json(); const rows = j.rows || [];
          if (!rows.length) { container.innerHTML = '<div class="empty">No athletes found</div>'; return; }
          container.innerHTML = rows.map(a=>`<div class="athlete-card" data-id="${a.id}"><div class="row-top"><div class="name">${a.name||''}</div><div class="rank">ID: ${a.id}</div></div><div class="controls"><label>Nickname <input class="nick" value="${a.nickname||''}" placeholder="nickname"></label><label>Manual Strava ID <input class="manual" value="${a.manual_strava_id||''}" placeholder="strava id"></label></div><div class="card-actions"><button class="save btn">Save</button><span class="save-msg" style="margin-left:8px;color:var(--muted);display:none">Saved</span></div></div>`).join('');
          document.querySelectorAll('.save').forEach(b=>b.addEventListener('click', async (e)=>{
            const card = e.target.closest('.athlete-card'); const id = card.getAttribute('data-id'); const nick = card.querySelector('.nick').value.trim(); const manual = card.querySelector('.manual').value.trim(); const msg = card.querySelector('.save-msg');
            e.target.disabled = true; e.target.textContent = 'Saving...'; if (msg) { msg.style.display='none'; }
            try{
              const resp = await fetch(API + '/admin/athlete/' + encodeURIComponent(id), { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ nickname: nick || null, manual_strava_id: manual || null }) });
              const json = await resp.json(); if (!resp.ok) throw new Error(JSON.stringify(json));
              if (msg) { msg.style.display='inline-block'; setTimeout(()=>{ msg.style.display='none'; }, 2000); }
            }catch(err){ alert('Save failed: ' + (err.message||err)); }
            e.target.disabled = false; e.target.textContent = 'Save';
          }));
        }catch(e){ container.innerHTML = '<div class="error">Failed to load</div>'; }
      }
      document.getElementById('reloadBtn').addEventListener('click', load);
      document.getElementById('refreshBtn').addEventListener('click', async ()=>{
        const p = document.getElementById('processing'); const btn = document.getElementById('refreshBtn');
        btn.disabled = true; btn.textContent = 'Processing…'; p.style.display='block';
        try{
          await fetch(API + '/aggregate/weekly', { method: 'POST' });
          await load();
        }catch(e){ alert('Aggregation failed: ' + (e.message||e)); }
        p.style.display='none'; btn.disabled = false; btn.textContent = 'Refresh Aggregation';
      });
      load();
    </script>
  </body>
</html>
